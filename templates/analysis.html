{% extends "base.html" %}

{% block title %}WeatherAI - Analysis{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <!-- Analysis Controls -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900">Weather Analysis</h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="city-input" placeholder="Enter city name" 
                           class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="days-select" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <button onclick="updateAnalysis()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Update Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Temperature Analysis -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Temperature Analysis</h3>
            <div id="temperature-stats" class="space-y-4">
                <!-- Temperature stats will be added here -->
            </div>
        </div>

        <!-- Humidity Analysis -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Humidity Analysis</h3>
            <div id="humidity-stats" class="space-y-4">
                <!-- Humidity stats will be added here -->
            </div>
        </div>

        <!-- Wind Speed Analysis -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Wind Speed Analysis</h3>
            <div id="wind-stats" class="space-y-4">
                <!-- Wind stats will be added here -->
            </div>
        </div>

        <!-- Pressure Analysis -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Pressure Analysis</h3>
            <div id="pressure-stats" class="space-y-4">
                <!-- Pressure stats will be added here -->
            </div>
        </div>
    </div>

    <!-- Weather Conditions -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Weather Conditions</h3>
        <div id="weather-conditions" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Weather conditions will be added here -->
        </div>
    </div>

    <!-- Recent Weather Data -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Weather Data</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temperature</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Humidity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wind Speed</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pressure</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
                    </tr>
                </thead>
                <tbody id="recent-weather-data" class="bg-white divide-y divide-gray-200">
                    <!-- Recent weather data will be added here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentCity = 'London';

    // Update analysis
    async function updateAnalysis() {
        const cityInput = document.getElementById('city-input');
        const daysSelect = document.getElementById('days-select');
        
        if (cityInput.value) {
            currentCity = cityInput.value;
        }
        
        try {
            // Get analysis
            const analysisResponse = await fetch(`http://localhost:5000/api/weather/analysis?city=${currentCity}&days=${daysSelect.value}`);
            const analysisData = await analysisResponse.json();
            
            if (analysisData.status === 'success') {
                updateAnalysisDisplay(analysisData.data);
            } else {
                showError('Analysis', analysisData.message);
            }
            
            // Get recent weather
            const recentResponse = await fetch(`http://localhost:5000/api/weather/recent?city=${currentCity}&limit=10`);
            const recentData = await recentResponse.json();
            
            if (recentData.status === 'success') {
                updateRecentWeatherTable(recentData.data);
            }
        } catch (error) {
            console.error('Error updating analysis:', error);
            showError('Analysis', 'Failed to update analysis. Please try again later.');
        }
    }

    // Update analysis display
    function updateAnalysisDisplay(data) {
        // Update temperature stats
        const tempStats = document.getElementById('temperature-stats');
        tempStats.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-600">Mean Temperature</p>
                    <p class="text-2xl font-bold text-blue-700">${data.temperature.mean}°C</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-600">Temperature Range</p>
                    <p class="text-2xl font-bold text-blue-700">${data.temperature.min}°C - ${data.temperature.max}°C</p>
                </div>
            </div>
        `;

        // Update humidity stats
        const humidityStats = document.getElementById('humidity-stats');
        humidityStats.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-600">Mean Humidity</p>
                    <p class="text-2xl font-bold text-green-700">${data.humidity.mean}%</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-600">Humidity Range</p>
                    <p class="text-2xl font-bold text-green-700">${data.humidity.min}% - ${data.humidity.max}%</p>
                </div>
            </div>
        `;

        // Update wind stats
        const windStats = document.getElementById('wind-stats');
        windStats.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-600">Mean Wind Speed</p>
                    <p class="text-2xl font-bold text-purple-700">${data.wind_speed.mean} km/h</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-600">Wind Speed Range</p>
                    <p class="text-2xl font-bold text-purple-700">${data.wind_speed.min} - ${data.wind_speed.max} km/h</p>
                </div>
            </div>
        `;

        // Update pressure stats
        const pressureStats = document.getElementById('pressure-stats');
        pressureStats.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <p class="text-sm text-yellow-600">Mean Pressure</p>
                    <p class="text-2xl font-bold text-yellow-700">${data.pressure.mean} hPa</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <p class="text-sm text-yellow-600">Pressure Range</p>
                    <p class="text-2xl font-bold text-yellow-700">${data.pressure.min} - ${data.pressure.max} hPa</p>
                </div>
            </div>
        `;

        // Update weather conditions
        const weatherConditions = document.getElementById('weather-conditions');
        weatherConditions.innerHTML = '';
        
        for (const [condition, count] of Object.entries(data.weather_conditions)) {
            const conditionCard = document.createElement('div');
            conditionCard.className = 'bg-gray-50 p-4 rounded-lg';
            conditionCard.innerHTML = `
                <p class="text-sm text-gray-600">${condition}</p>
                <p class="text-2xl font-bold text-gray-700">${count} times</p>
            `;
            weatherConditions.appendChild(conditionCard);
        }
    }

    // Update recent weather table
    function updateRecentWeatherTable(data) {
        const tbody = document.getElementById('recent-weather-data');
        tbody.innerHTML = '';
        
        data.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.timestamp}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.temperature}°C</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.humidity}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.wind_speed} km/h</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.pressure} hPa</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.description}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Show error message
    function showError(section, message) {
        const errorMessage = `Error loading ${section}: ${message}`;
        console.error(errorMessage);
        
        // Create error alert
        const alertElement = document.createElement('div');
        alertElement.className = 'p-4 rounded-md bg-red-50 text-red-700 mb-4';
        alertElement.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium">${errorMessage}</p>
                </div>
            </div>
        `;
        
        // Add error at the top of the page
        const container = document.querySelector('.max-w-7xl');
        container.insertBefore(alertElement, container.firstChild);
    }

    // Initialize the analysis
    document.addEventListener('DOMContentLoaded', () => {
        updateAnalysis();
    });
</script>
{% endblock %} 